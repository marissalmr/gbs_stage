<h2>Pr√©-diagnostic</h2>

<form method="POST" id="prediag-form">
    {% csrf_token %}
    {{ form.as_p }}

    <!-- Message o√π le statut du SIRET sera affich√© -->
    <p id="siret-status" style="font-weight: bold;"></p>

    <button type="submit">Envoyer</button>
</form>

<script>
// On r√©cup√®re automatiquement le token CSRF g√©n√©r√© par Django
const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;

// On r√©cup√®re l'input du SIRET (il doit exister dans ton form)
const siretInput = document.querySelector('input[name="siret"]');

// Zone o√π afficher les messages
const statusBox = document.getElementById('siret-status');

if (siretInput) {
    // D√©clenche la v√©rification d√®s que l'utilisateur sort du champ
    siretInput.addEventListener('blur', () => {
        const siretValue = siretInput.value.trim();

        if (!siretValue) {
            statusBox.textContent = "Veuillez entrer un SIRET.";
            statusBox.style.color = "red";
            return;
        }

        // Envoi AJAX vers ton endpoint Django
        fetch("/prediagnostic/check-siret/", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": csrftoken
            },
            body: JSON.stringify({ siret: siretValue })
        })
        .then(response => response.json().then(data => ({status: response.status, body: data})))
        .then(result => {
            const { status, body } = result;

            if (status === 200) {
                // R√©ponse OK ‚Üí on v√©rifie si le SIRET existe
                if (body.exists) {
                    statusBox.textContent = "üü¢ SIRET valide : entreprise trouv√©e.";
                    statusBox.style.color = "green";
                } else {
                    statusBox.textContent = "üî¥ SIRET inconnu ou invalide.";
                    statusBox.style.color = "red";
                }
            } else {
                // Erreur envoy√©e depuis Django (status=400)
                statusBox.textContent = "‚ö†Ô∏è Erreur : " + body.error;
                statusBox.style.color = "red";
            }
        })
        .catch(() => {
            // Erreur serveur (status=500)
            statusBox.textContent = "‚ö†Ô∏è Erreur serveur lors de la v√©rification.";
            statusBox.style.color = "red";
        });
    });
}
</script>
